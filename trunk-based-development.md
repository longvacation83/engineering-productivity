> 本文内容主要参考网站 <https://trunkbaseddevelopment.com/> 的论述，同时融入了自己的研发实践。
> 本文默认代码的版本管理工具（Source Control Management）为Git <https://git-scm.com/>。

## 主干开发模式
英文单词Trunk翻译为中文是“树干”。Trunk Based Development（TBD）是一种代码仓库的分支管理策略，称为`主干开发模式`。团队成员在约定的主干分支上（比如master分支）协作进行代码的修改提交，避免同时在多个长期存在的分支并行开发。相比分支开发模式（Feature Based Development，例如GitFlow等），TBD更适合软件研发中的持续集成（CI，Continuous Integration）和持续交付（CD，Continuous Delivery）实践。

![image](https://user-images.githubusercontent.com/12379685/190977449-e40a3fac-d540-4625-a1ec-e42de047d078.png)

## 主干开发模式的特征

### 有助于实现持续集成和交付

> CI/CD 是一种通过在应用开发阶段引入自动化来频繁向客户交付应用的方法。CI/CD 的核心概念是持续集成、持续交付和持续部署。作为一个面向开发和运营团队的解决方案，CI/CD 主要针对在集成新代码时所引发的问题（亦称："集成地狱"）。

很多公司使用的版本管理工具是Git，同时使用GitLab作为Git配套的Web端管理工具和DevOps平台。通过配置`.gitlab-ci.yml`可以很方便的开启持续集成&交付，实现代码提交后的静态扫描，编译，测试集验证，以及上线部署等流程。

CI/CD的理念是小步快行：快速修改，快速验证，快速部署。标准化的研发流程可以引入很多环节（比如：产品调研需求->进行需求评审/UI设计->技术评审->需求反串讲->开发->测试->验收->UAT/用户培训->上线），如果研发时间太长，长期看不到投入产出和反馈，无论对需求方，还是产研团队都是一种慢性损耗。

在主干开发模式下，团队成员一天多次将代码提交到主干分支，满足持续交付的必要条件；团队的工作也可以快速被整合，保证代码版本随时处于可发布状态，使得持续交付成为可能。


CI/CD的理念对于面向C端的网络服务尤为重要：无论是从满足用户新需求，解决用户遇到问题，提升用户体验以便保持快速增长占领市场份额的角度；还是从提升企业内部研发效率和组织管理水平，以应对快速变化的市场角度，CI/CD都是最佳的选择。

实际上即便是B端软件开发（比如目前常被提到的企业信息化/数字化系统等），快速迭代上线也是研发团队亟需的核心能力。企业信息化系统是企业战略和流程管理的体现，战略的执行强调强执行力。想要真正提升研发管理水平和软件质量，代码管理是重点。研发管理从宏观角度无论管理理念如何先进，无法落实到围绕代码质量的流程建设，最终都会事倍功半。

> 根据笔者同业务方交流的经验，B端软件（比如典型的如飞书）不强调交互的个性化，更强调使用体验的标准化和流畅性。经常遇到的一个尴尬场景，是业务方提了一个并不复杂的需求，但由于能力或资源的限制，产研团队评估后往往会给业务方一个很夸张的人天预估（比如按照现有人力看起来最多一周的工作，评估了1个月），导致业务方的信息化实施热情被极大的打击。往往系统经过长期开发后，交付给业务方的是一个充斥大量bug的系统，根本没法使用，或者业务方发现系统并不是他们想要的效果（在开发中经常出现这种情况），导致系统刚开发完成就被弃用。另外B端系统开发中经常会引入外包团队（人员外包或项目外包），通过短时间引入大量人力的方式，尝试提升研发速度。但外包引入尝尝带来人员管理的额外成本，培训&融入需要花费大量时间，且外包人员平均水平较差，代码质量最终会不断劣化，后续迭代速度难以提升。

### 分支管理策略

- 在TBD模式中，同样存在特性分支（Feature Branch），但这些特性分支生命周期很短，其作用是用于代码审核（Code Review）和持续集成（CI）。对于人数较少的团队，也可能不使用特性分支，直接向主干上提交。

- 可能存在Release分支。release分支基于主干创建（比如使用git tag命令）。这种分支相当于在恰当时刻为主干创建了一个快照，便于进行代码的部署和回滚，以及紧急问题的修复。release分支在一段时间后往往被删除并不长期存在。因为主干代码在快速修改推进，在新的release分支创建并部署验证后，一些较为陈旧的release分支可以被删除（保留若干release分支便于快速回滚）。假如主干分支已经有了新的提交（但还不能被马上部署），同时存在线上bug需要修复，可以基于release分支进行hotfix。

- 可能短期存在develop分支。develop分支作为功能迭代分支，在一段时间内团队使用develop分支作为主干分支，所有的修改和测试都围绕develop分支进行，使用develop分支部署测试环境。当开发测试完成后，将develop分支整体合并到主干分支，并删除develop分支。

（未完待续...）

![image](https://user-images.githubusercontent.com/12379685/190990697-fb67a620-ed93-4301-a1b7-d7eb154e5783.png)

